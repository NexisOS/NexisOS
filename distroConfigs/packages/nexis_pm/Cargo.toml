[package]
name = "nexis_pm"
version = "0.1.0"
edition = "2021"
authors = ["Kyle Gortych <kyle.gortych.dev@gmail.com>"]
description = "Declarative system package manager for NexisOS with optimized store operations and generation rollbacks"
license = "GPL-3.0-or-later"
repository = "https://github.com/NexisOS/NexisOS"
homepage = "https://github.com/NexisOS/NexisOS"
readme = "README.md"
keywords = ["package-manager", "linux", "declarative", "immutable", "rollback"]
categories = ["command-line-utilities", "development-tools", "os"]

[lib]
name = "nexis_pm"
path = "src/lib.rs"

[[bin]]
name = "nexis"
path = "src/main.rs"

[dependencies]
nexis_common = { path = "../nexis_common" }

# CLI and configuration
clap = { version = "4.5", features = ["derive", "env", "color"] }
serde = { version = "1.0", features = ["derive"] }
toml = "0.8"
toml_edit = "0.22"
merge = "0.1"  # For merging TOML configs (profiles + machines + base)

# Validation & diagnostics
miette = { version = "7", features = ["fancy"] }
thiserror = "1.0"
anyhow = "1.0"

# Storage backend - redb (embedded key-value store)
redb = "2.1"

# Async runtime and networking
tokio = { version = "1", features = ["rt-multi-thread", "macros", "fs", "process", "io-util", "signal", "time"] }
reqwest = { version = "0.12", features = ["stream", "rustls-tls", "gzip", "brotli", "hickory-dns"], default-features = false }
futures = "0.3"

# Hashing - BLAKE3 with parallel support
blake3 = { version = "1", features = ["rayon"] }

# Dependency graph resolution
petgraph = "0.6"

# Git operations and version parsing
gix = { version = "0.66", features = ["blocking-http-transport-reqwest-rust-tls"], default-features = false }
semver = "1.0"

# Compression and archive handling
tar = "0.4"
zstd = { version = "0.13", features = ["pkg-config"] }
flate2 = "1.0"

# Filesystem operations
walkdir = "2.5"
tempfile = "3.10"
camino = "1.1"
fs-err = "2.0"

# XFS reflink support
reflink-copy = "0.1"

# Unix system calls and user management
rustix = { version = "0.38", features = ["fs", "process", "pipe"] }
uzers = "0.12"

# SELinux integration
selinux = "0.4"

# Dinit service management
ini = "1.3"
indexmap = "2.5"

# Parallel processing
rayon = "1.10"
crossbeam = "0.8"
dashmap = "6.1"

# Logging and debugging
tracing = { version = "0.1", features = ["log", "attributes"] }
tracing-subscriber = { version = "0.3", features = ["env-filter", "fmt", "ansi", "tracing-log"] }
tracing-appender = "0.2"

# Date/time
chrono = { version = "0.4", features = ["serde"] }

# Serialization
serde_json = "1.0"

# CLI UX
console = "0.15"
indicatif = "0.17"
colored = "2.1"

# Utilities
regex = "1.11"
glob = "0.3"
pathdiff = "0.2"
once_cell = "1.20"
sha2 = "0.10"  # For content-addressable file hashing
dirs = "5.0"   # For resolving config directories

[dev-dependencies]
assert_fs = "1.1"
predicates = "3.1"
tokio-test = "0.4"
criterion = { version = "0.5", features = ["html_reports"] }

[features]
default = [
    "selinux-enforce",
    "dinit-services",
    "parallel-builds",
    "version-resolution",
    "fleet-management"
]

# Core features
selinux-enforce = ["selinux"]
dinit-services = ["ini", "indexmap"]
parallel-builds = ["rayon", "crossbeam", "dashmap"]
version-resolution = ["gix", "semver", "regex"]
fleet-management = ["merge", "dirs"]  # Profile/machine composition

# Optional enhancements
build-cache = []  # Enable build caching infrastructure
sandbox = []      # Enable build sandboxing

[profile.release]
lto = "thin"
codegen-units = 1
panic = "abort"
opt-level = 3
strip = true

[profile.dev]
opt-level = 1
debug = 2

[[bench]]
name = "store_operations"
harness = false
